// ===========================================================================
// FOF: Friends of Farcaster - Database Schema
// Simple but complete - all useful data, no complexity
// ===========================================================================

generator client {
    provider = "prisma-client"
    output   = "./generated"
}

datasource db {
    provider = "postgresql"
}

// ===========================================================================
// USER - Farcaster identity + stats
// ===========================================================================

model User {
    id  Int @id @default(autoincrement())
    fid Int @unique

    // Profile (from Farcaster)
    username    String?
    displayName String?
    pfpUrl      String?

    // Wallet for NFT minting
    wallet String?

    // Points (simple accumulator)
    points Int @default(0)

    // Waffles integration
    isOnWaitlist Boolean @default(false)

    // Timestamps
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    // Relations
    generations Generation[]

    @@index([fid])
    @@index([points(sort: Desc)])
}

// ===========================================================================
// GENERATION - FOF image with all tracking
// ===========================================================================

model Generation {
    id Int @id @default(autoincrement())

    user   User @relation(fields: [userId], references: [id], onDelete: Cascade)
    userId Int

    // The generated image
    imageUrl    String
    friendCount Int
    friendFids  Int[]

    // Generation config
    prompt String?
    model  String?

    // Payment (optional - if paid generation)
    paymentTxHash String? @unique
    paymentAmount Float?

    // NFT minting (optional - if collected as NFT)
    nftTxHash   String? @unique
    nftTokenId  String?
    nftTokenUri String?

    // Sharing tracking
    sharedOnFarcaster Boolean @default(false)
    farcasterCastHash String?
    shareCount        Int     @default(0)

    // Timestamps
    createdAt DateTime @default(now())

    @@index([userId, createdAt(sort: Desc)])
    @@index([paymentTxHash])
    @@index([nftTxHash])
}

// ===========================================================================
// NOTIFICATION TOKEN - Farcaster notifications
// ===========================================================================

model NotificationToken {
    id Int @id @default(autoincrement())

    fid    Int
    appFid Int
    token  String
    url    String

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@unique([fid, appFid])
    @@index([token])
}
