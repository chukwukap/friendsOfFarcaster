// ===========================================================================
// FOF: Friends of Farcaster - Database Schema
// Simple, rock-solid design
// ===========================================================================

generator client {
    provider = "prisma-client"
    output   = "./generated"
}

datasource db {
    provider = "postgresql"
}

// ===========================================================================
// USER - Core identity
// ===========================================================================

model User {
    id  Int @id @default(autoincrement())
    fid Int @unique

    // Profile (from Farcaster)
    username    String? @db.VarChar(50)
    displayName String? @db.VarChar(100)
    pfpUrl      String? @db.VarChar(500)

    // Wallet for NFT
    wallet String? @db.VarChar(42)

    // Points
    points Int @default(0)

    // Waffles integration
    isOnWaitlist Boolean @default(false)

    // Timestamps
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    // Relations
    generations Generation[]
    collections Collection[]
    shares      Share[]
    payments    Payment[]

    @@index([fid])
    @@index([points(sort: Desc)])
}

// ===========================================================================
// GENERATION - FOF image creation
// ===========================================================================

model Generation {
    id Int @id @default(autoincrement())

    user   User @relation(fields: [userId], references: [id], onDelete: Cascade)
    userId Int

    // Image
    imageUrl String @db.VarChar(500)

    // Config
    prompt      String  @db.VarChar(5000)
    model       String? @db.VarChar(100) // AI model used
    friendCount Int     @db.SmallInt
    friendFids  Int[]

    // Processing
    status   GenerationStatus @default(PENDING)
    duration Int?             @db.SmallInt // ms

    // Points awarded
    points Int @default(100) @db.SmallInt

    // Timestamps
    createdAt   DateTime  @default(now())
    completedAt DateTime?

    // Relations
    collection Collection?
    shares     Share[]
    payment    Payment?

    @@index([userId, createdAt(sort: Desc)])
    @@index([status])
}

enum GenerationStatus {
    PENDING
    PROCESSING
    COMPLETED
    FAILED
}

// ===========================================================================
// COLLECTION - NFT minting
// ===========================================================================

model Collection {
    id Int @id @default(autoincrement())

    user   User @relation(fields: [userId], references: [id], onDelete: Cascade)
    userId Int

    generation   Generation @relation(fields: [generationId], references: [id], onDelete: Cascade)
    generationId Int        @unique

    // Blockchain
    chainId         Int     @db.SmallInt
    contractAddress String  @db.VarChar(42)
    tokenId         BigInt?
    txHash          String? @unique @db.VarChar(66)
    tokenUri        String? @db.VarChar(500)

    // Status
    status CollectionStatus @default(PENDING)

    // Points
    points Int @default(50) @db.SmallInt

    // Timestamps
    createdAt DateTime  @default(now())
    mintedAt  DateTime?

    @@index([userId])
    @@index([txHash])
}

enum CollectionStatus {
    PENDING
    MINTING
    COMPLETED
    FAILED
}

// ===========================================================================
// SHARE - Social sharing
// ===========================================================================

model Share {
    id Int @id @default(autoincrement())

    user   User @relation(fields: [userId], references: [id], onDelete: Cascade)
    userId Int

    generation   Generation @relation(fields: [generationId], references: [id], onDelete: Cascade)
    generationId Int

    // Platform
    platform SharePlatform
    castHash String?       @db.VarChar(66)

    // Points
    points Int @default(25) @db.SmallInt

    // Timestamps
    createdAt DateTime @default(now())

    @@index([userId])
    @@index([generationId])
}

enum SharePlatform {
    FARCASTER
    TWITTER
    DOWNLOAD
}

// ===========================================================================
// PAYMENT - Monetization
// ===========================================================================

model Payment {
    id Int @id @default(autoincrement())

    user   User @relation(fields: [userId], references: [id])
    userId Int

    generation   Generation @relation(fields: [generationId], references: [id])
    generationId Int        @unique

    // Amount
    amount   Float // USD
    currency String @default("USDC") @db.VarChar(10)

    // Discount (Waffles waitlist)
    discount    Float? // Amount saved
    discountPct Int?   @db.SmallInt // 50 for 50%

    // Blockchain
    txHash String? @unique @db.VarChar(66)

    // Status
    status PaymentStatus @default(PENDING)

    // Timestamps
    createdAt   DateTime  @default(now())
    confirmedAt DateTime?

    @@index([userId])
    @@index([txHash])
}

enum PaymentStatus {
    PENDING
    COMPLETED
    FAILED
    REFUNDED
}

// ===========================================================================
// NOTIFICATION TOKEN - Farcaster notifications
// ===========================================================================

model NotificationToken {
    id Int @id @default(autoincrement())

    fid    Int
    appFid Int
    token  String @db.VarChar(255)
    url    String @db.VarChar(500)

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@unique([fid, appFid])
    @@index([token])
}
